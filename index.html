<!DOCTYPE html>
<html>
  <head>
    <title>AR Video - Debug</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
      #debugInfo {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 10px;
        border-radius: 5px;
        z-index: 1000;
        font-size: 12px;
      }
      #errorLog {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(255,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        z-index: 1000;
        font-size: 12px;
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- Debug info -->
    <div id="debugInfo">
      <div>Status: Ładowanie...</div>
      <div id="cameraStatus">Kamera: Sprawdzanie...</div>
      <div id="arStatus">AR: Inicjalizacja...</div>
    </div>

    <!-- Error log -->
    <div id="errorLog">
      <div id="errorText"></div>
    </div>

    <a-scene
      vr-mode-ui="enabled: false;"
      arjs="
        debugUIEnabled: false;
        detectionMode: mono_and_matrix;
        matrixCodeType: 3x3;
        sourceType: webcam;
        sourceWidth: 1280;
        sourceHeight: 960;
        displayWidth: 1280;
        displayHeight: 960;
      "
      embedded
      loading-screen="enabled: false;"
      renderer="logarithmicDepthBuffer: true;"
    >

      <!-- Wideo WebM z przezroczystością -->
      <a-assets>
        <video
          id="transparentVideo"
          src="skelet.webm"
          autoplay
          loop="true"
          playsinline
          webkit-playsinline
          muted
          crossorigin="anonymous"
          preload="auto"
        ></video>
      </a-assets>

      <!-- Marker z przezroczystą animacją WebM - PROSTOPADŁA -->
      <a-marker preset="hiro" id="hiroMarker">

        <!-- Główna animacja - PIONOWA płaszczyzna (prostopadła do ciebie) -->
        <a-plane
          position="0 2 0"
          rotation="0 0 0"
          width="4"
          height="4"
          material="src: #transparentVideo; transparent: true; alphaTest: 0.01; side: double;blending: normal;"
        ></a-plane>

          <a-plane
          id="plane2"
          position="0 2 0"
          rotation="0 0 0"
          width="3"
          height="3"
          material="src: #transparentVideo; transparent: true; opacity: 1.0; side: double; blending: additive;"
        ></a-plane>

          <a-plane
          id="plane3"
          position="2 2 0"
          rotation="0 0 0"
          width="3"
          height="3"
          material="shader: transparent-video; src: #transparentVideo; side: double;"
        ></a-plane>

        <!-- Debug box na środku markera -->
        <a-box
          position="0 0.1 0"
          width="0.2"
          height="0.2"
          depth="0.2"
          material="color: red; opacity: 0.8"
        ></a-box>

      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>

      // Custom shader dla WebM z przezroczystością
      AFRAME.registerShader('transparent-video', {
        schema: {
          src: {type: 'map'}
        },
        init: function (data) {
          const material = new THREE.MeshBasicMaterial({
            map: data.src,
            transparent: true,
            alphaTest: 0.01,
            side: THREE.DoubleSide
          });
          this.material = material;
        },
        update: function (data) {
          this.material.map = data.src;
          this.material.needsUpdate = true;
        }
      });



      // Debug i error handling
      let debugDiv = document.getElementById('debugInfo');
      let errorDiv = document.getElementById('errorLog');
      let errorText = document.getElementById('errorText');

      function updateDebug(status) {
        debugDiv.innerHTML = `
          <div>Status: ${status}</div>
          <div id="cameraStatus">Kamera: ${navigator.mediaDevices ? 'Dostępna' : 'Niedostępna'}</div>
          <div id="arStatus">AR: ${status}</div>
          <div>HTTPS: ${location.protocol === 'https:' ? 'TAK' : 'NIE'}</div>
          <div>User Agent: ${navigator.userAgent.substr(0, 50)}...</div>
        `;
      }

      function showError(message) {
        errorText.textContent = message;
        errorDiv.style.display = 'block';
        console.error('AR Error:', message);
      }

      // Sprawdź dostęp do kamery
      async function checkCameraAccess() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          console.log('Kamera dostępna');
          stream.getTracks().forEach(track => track.stop());
          updateDebug('Kamera OK');
          return true;
        } catch (error) {
          console.error('Błąd kamery:', error);
          showError(`Błąd kamery: ${error.message}`);
          updateDebug('Błąd kamery');
          return false;
        }
      }

      // Event listeners dla A-Frame i AR.js
      document.querySelector('a-scene').addEventListener('loaded', () => {
        console.log('A-Scene loaded');
        updateDebug('A-Scene załadowana');
      });

      document.querySelector('a-scene').addEventListener('arjs-video-loaded', () => {
        console.log('AR video loaded');
        updateDebug('Video AR załadowane');
      });

      document.querySelector('[camera]').addEventListener('loaded', () => {
        console.log('Camera loaded');
        updateDebug('Kamera załadowana');
      });

      // Sprawdź marker detection
      document.querySelector('#hiroMarker').addEventListener('markerFound', () => {
        console.log('Marker found!');
        updateDebug('Marker znaleziony!');
      });

      document.querySelector('#hiroMarker').addEventListener('markerLost', () => {
        console.log('Marker lost');
        updateDebug('Marker zgubiony');
      });

      // Error handling
      window.addEventListener('error', (e) => {
        showError(`JS Error: ${e.message}`);
      });

      // Sprawdź środowisko
      window.addEventListener('load', async () => {
        updateDebug('Sprawdzanie środowiska...');

        // Sprawdź HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          showError('WYMAGANE HTTPS! Kamera działa tylko na HTTPS.');
        }

        // Sprawdź dostęp do kamery
        await checkCameraAccess();

        // Sprawdź WebGL
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) {
          showError('WebGL nie jest obsługiwany przez tę przeglądarkę');
        }

        updateDebug('Inicjalizacja zakończona');
      });

      // Dodatkowy debug dla video + FIX dla odtwarzania
      const video = document.getElementById('transparentVideo');
      if (video) {
        // FORCE autoplay przy wykryciu markera
        document.querySelector('#hiroMarker').addEventListener('markerFound', () => {
          console.log('Marker found - forcing video play');
          video.currentTime = 0;
          video.play().catch(e => console.log('Play failed:', e));
        });

        video.addEventListener('loadeddata', () => {
          console.log('Video loaded:', video.videoWidth + 'x' + video.videoHeight);
          updateDebug(`Video: ${video.videoWidth}x${video.videoHeight}`);
          // Force play
          video.play().catch(e => console.log('Initial play failed:', e));
        });

        video.addEventListener('error', (e) => {
          console.error('Video error:', e);
          showError(`Video error: ${video.error ? video.error.message : 'Unknown'}`);
        });

        video.addEventListener('canplay', () => {
          console.log('Video can play - attempting autoplay');
          updateDebug('Video gotowe do odtwarzania');
          video.play().catch(e => console.log('Autoplay blocked:', e));
        });

        video.addEventListener('play', () => {
          console.log('Video started playing');
          updateDebug('Video GRA!');
        });

        video.addEventListener('pause', () => {
          console.log('Video paused');
        });
      }
      setTimeout(() => {
        if (debugDiv.textContent.includes('Ładowanie...')) {
          showError('Timeout - sprawdź połączenie i uprawnienia kamery');
        }
      }, 15000);
    </script>
  </body>
</html>