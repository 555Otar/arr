<!DOCTYPE html>
<html>
  <head>
    <title>AR Video - Debug</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
      #debugInfo {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 10px;
        border-radius: 5px;
        z-index: 1000;
        font-size: 12px;
      }
      #errorLog {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(255,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        z-index: 1000;
        font-size: 12px;
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- Debug info -->
    <div id="debugInfo">
      <div>Status: Ładowanie...</div>
      <div id="cameraStatus">Kamera: Sprawdzanie...</div>
      <div id="arStatus">AR: Inicjalizacja...</div>
    </div>

    <!-- Error log -->
    <div id="errorLog">
      <div id="errorText"></div>
    </div>

    <a-scene
      vr-mode-ui="enabled: false;"
      arjs="
        debugUIEnabled: false;
        detectionMode: mono_and_matrix;
        matrixCodeType: 3x3;
        sourceType: webcam;
        sourceWidth: 1280;
        sourceHeight: 960;
        displayWidth: 1280;
        displayHeight: 960;
      "
      embedded
      loading-screen="enabled: false;"
      renderer="logarithmicDepthBuffer: true;"
    >

      <!-- Wideo jako tekstura -->
      <a-assets>
        <video
          id="vid"
          src="video.mp4"
          autoplay
          loop="true"
          playsinline
          webkit-playsinline
          muted
          crossorigin="anonymous"
        ></video>
      </a-assets>

      <!-- Marker Hiro -->
      <a-marker preset="hiro" id="hiroMarker">
        <a-box
          position="0 0.5 0"
          material="color: red; opacity: 0.7;"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 10000"
        ></a-box>
        <a-text
          value="AR działa!"
          position="0 1.5 0"
          align="center"
          color="white"
        ></a-text>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      // Debug i error handling
      let debugDiv = document.getElementById('debugInfo');
      let errorDiv = document.getElementById('errorLog');
      let errorText = document.getElementById('errorText');

      function updateDebug(status) {
        debugDiv.innerHTML = `
          <div>Status: ${status}</div>
          <div id="cameraStatus">Kamera: ${navigator.mediaDevices ? 'Dostępna' : 'Niedostępna'}</div>
          <div id="arStatus">AR: ${status}</div>
          <div>HTTPS: ${location.protocol === 'https:' ? 'TAK' : 'NIE'}</div>
          <div>User Agent: ${navigator.userAgent.substr(0, 50)}...</div>
        `;
      }

      function showError(message) {
        errorText.textContent = message;
        errorDiv.style.display = 'block';
        console.error('AR Error:', message);
      }

      // Sprawdź dostęp do kamery
      async function checkCameraAccess() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          console.log('Kamera dostępna');
          stream.getTracks().forEach(track => track.stop());
          updateDebug('Kamera OK');
          return true;
        } catch (error) {
          console.error('Błąd kamery:', error);
          showError(`Błąd kamery: ${error.message}`);
          updateDebug('Błąd kamery');
          return false;
        }
      }

      // Event listeners dla A-Frame i AR.js
      document.querySelector('a-scene').addEventListener('loaded', () => {
        console.log('A-Scene loaded');
        updateDebug('A-Scene załadowana');
      });

      document.querySelector('a-scene').addEventListener('arjs-video-loaded', () => {
        console.log('AR video loaded');
        updateDebug('Video AR załadowane');
      });

      document.querySelector('[camera]').addEventListener('loaded', () => {
        console.log('Camera loaded');
        updateDebug('Kamera załadowana');
      });

      // Sprawdź marker detection
      document.querySelector('#hiroMarker').addEventListener('markerFound', () => {
        console.log('Marker found!');
        updateDebug('Marker znaleziony!');
      });

      document.querySelector('#hiroMarker').addEventListener('markerLost', () => {
        console.log('Marker lost');
        updateDebug('Marker zgubiony');
      });

      // Error handling
      window.addEventListener('error', (e) => {
        showError(`JS Error: ${e.message}`);
      });

      // Sprawdź środowisko
      window.addEventListener('load', async () => {
        updateDebug('Sprawdzanie środowiska...');

        // Sprawdź HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          showError('WYMAGANE HTTPS! Kamera działa tylko na HTTPS.');
        }

        // Sprawdź dostęp do kamery
        await checkCameraAccess();

        // Sprawdź WebGL
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) {
          showError('WebGL nie jest obsługiwany przez tę przeglądarkę');
        }

        updateDebug('Inicjalizacja zakończona');
      });

      // Timeout dla długiego ładowania
      setTimeout(() => {
        if (debugDiv.textContent.includes('Ładowanie...')) {
          showError('Timeout - sprawdź połączenie i uprawnienia kamery');
        }
      }, 15000);
    </script>
  </body>
</html>